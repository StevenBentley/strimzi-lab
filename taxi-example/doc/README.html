<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.8">
<meta name="author" content="Adam Cattermole">
<title>Building a Kafka Streams Application</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Building a Kafka Streams Application</h1>
<div class="details">
<span id="author" class="author">Adam Cattermole</span><br>
<span id="revdate">08-04-2019</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_basic_example">Basic Example</a>
<ul class="sectlevel2">
<li><a href="#_strimzi_setup">Strimzi Setup</a></li>
<li><a href="#_create_a_producer">Create a Producer</a></li>
<li><a href="#_create_a_streams_app">Create a Streams App</a></li>
</ul>
</li>
<li><a href="#_example_using_real_data">Example using real data</a>
<ul class="sectlevel2">
<li><a href="#_datasetproblem">Dataset/Problem</a></li>
<li><a href="#_getting_data_into_the_system">Getting Data into the System</a></li>
<li><a href="#_kafka_streams_operations_on_the_data">Kafka Streams Operations on the Data</a></li>
<li><a href="#_aggregation">Aggregation</a></li>
<li><a href="#_consume_and_visualise">Consume and Visualise</a></li>
<li><a href="#_system_architecture">System Architecture</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Within this article we describe the steps required to get started with
building your own Kafka Streams application using Strimzi. We start
with a simple example and build upon it to create a multi-stage
pipeline, performing some operations on the data stream, and visualising
at the consumer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_example">Basic Example</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_strimzi_setup">Strimzi Setup</h3>
<div class="paragraph">
<p>First things first, follow the instructions in the <a href="https://strimzi.io/quickstarts/">Strimzi quickstart documentation</a> to get a Kafka cluster deployed.
All of the subsequent parts of this documentation assume you have followed these steps.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_producer">Create a Producer</h3>
<div class="paragraph">
<p>To get started we need a flow of data streaming into Kafka.
This could come from a variety of different sources, but for the purposes of this application lets generate sample data, using <code>String</code>s sent with a delay.</p>
</div>
<div class="paragraph">
<p>We need to configure the Kafka Producer so that it knows how to talk to the
Kafka brokers (see <a href="https://strimzi.io/2019/04/17/accessing-kafka-part-1.html">this article</a> for a more in-depth explanation of how this works), as well as provide information such as the topic name to write to.
As our application will be containerised, we can abstract this away from the producer code, and read it from environment variables.
This could be done in an external configuration file, but for this simple example the following will be sufficient.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">private static final String DEFAULT_BOOTSTRAP_SERVERS = "localhost:9092";
private static final int DEFAULT_DELAY = 1000;
private static final String DEFAULT_TOPIC = "source-topic";

private static final String BOOTSTRAP_SERVERS = "BOOTSTRAP_SERVERS";
private static final String DELAY = "DELAY";
private static final String TOPIC = "TOPIC";

private static final String ACKS = "1";

String bootstrapServers = System.getenv().getOrDefault(BOOTSTRAP_SERVERS, DEFAULT_BOOTSTRAP_SERVERS);
long delay = Long.parseLong(System.getenv().getOrDefault(DELAY, String.valueOf(DEFAULT_DELAY)));
String topic = System.getenv().getOrDefault(TOPIC, DEFAULT_TOPIC);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now create appropriate properties for our Kafka Producer using the
environment variables (or the defaults).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">Properties props = new Properties();
props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
props.put(ProducerConfig.ACKS_CONFIG, ACKS);
props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, "org.apache.kafka.common.serialization.StringSerializer");
props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, "org.apache.kafka.common.serialization.StringSerializer");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us create the Producer with the configuration properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">KafkaProducer&lt;String,String&gt; producer = new KafkaProducer&lt;&gt;(props);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now stream the data to the provided <code>topic</code>, giving the required <code>delay</code> between each message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">int i = 0;
while (true) {
    String value = String.format("hello world %d", i);
    ProducerRecord&lt;String, String&gt; record = new ProducerRecord&lt;&gt;(topic, value);
    log.info("Sending record {}", record);
    producer.send(record);
    i++;
    try {
        Thread.sleep(delay);
    } catch (InterruptedException e) {
        // sleep interrupted, continue
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The only thing left to do is to package the application into a docker image and push it to docker hub.
We can then make a new deployment in our Kubernetes cluster from the image, providing the environment variables for our cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    app: basic-example
  name: basic-producer
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: basic-producer
    spec:
      containers:
      - name: basic-producer
        image: &lt;docker-user&gt;/basic-producer:latest
        env:
          - name: BOOTSTRAP_SERVERS
            value: my-cluster-kafka-bootstrap:9092
          - name: DELAY
            value: 1000
          - name: TOPIC
            value: source-topic</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can check that data is arriving at our topic by consuming from it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">kubectl run kafka-consumer -n kafka -ti --image=strimzi/kafka:0.11.1-kafka-2.1.0 --rm=true --restart=Never -- bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9092 --topic source-topic --from-beginning</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_streams_app">Create a Streams App</h3>
<div class="paragraph">
<p>A Kafka Streams application will typically read/source data from one topic, and write/send data to another.
We can setup the properties and configuration in the same way as before, but this time we need to specify a <code>SOURCE_TOPIC</code> and <code>SINK_TOPIC</code>.</p>
</div>
<div class="paragraph">
<p>Let us create the <code>source</code> stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">StreamsBuilder builder = new StreamsBuilder();
KStream&lt;String, String&gt; source = builder.stream(sourceTopic);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now perform an operation on this <code>source</code> stream, for example we could create a new stream <code>filtered</code>, that only contains records with an even numbered index:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">KStream&lt;String, String&gt; filtered = source
        .filter((key, value) -&gt; {
            int i = Integer.parseInt(value.split(" ")[2]);
            return (i % 2) == 0;
        });</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can then be output to the <code>sinkTopic</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">filtered.to(sinkTopic);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly we can create the streams object and create a shutdown handler.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">final KafkaStreams streams = new KafkaStreams(builder.build(), props);
final CountDownLatch latch = new CountDownLatch(1);

// attach shutdown handler to catch control-c
Runtime.getRuntime().addShutdownHook(new Thread("streams-shutdown-hook") {
    @Override
    public void run() {
        streams.close();
        latch.countDown();
    }
});

try {
    streams.start();
    latch.await();
} catch (Throwable e) {
    System.exit(1);
}
System.exit(0);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is as simple as this to get our streams application running.
Build the application into a docker image and deploy in a similar way to the producer, and you can watch the <code>sinkTopic</code> for the output!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_example_using_real_data">Example using real data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Building upon the basic example above, we will look at the design decisions and considerations while building an application to process a real-life data set.</p>
</div>
<div class="sect2">
<h3 id="_datasetproblem">Dataset/Problem</h3>
<div class="paragraph">
<p>The data we have chosen for this example is New York City taxi journey information from 2013, which was the dataset for the <a href="http://www.debs2015.org/call-grand-challenge.html">Distributed Event Based Systems (DEBS) Grand Challenge in 2015</a>.
For a description of the source of the data, see <a href="https://chriswhong.com/open-data/foil_nyc_taxi/">the article here</a>.</p>
</div>
<div class="paragraph">
<p>The dataset is provided as a CSV file, with the columns detailed below:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>medallion</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">an md5sum of the identifier of the taxi - vehicle bound</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hack_license</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">an md5sum of the identifier for the taxi license</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pickup_datetime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">time when the passenger(s) were picked up</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dropoff_datetime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">time when the passenger(s) were dropped off</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>trip_time_in_secs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">duration of the trip</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>trip_distance</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trip distance in miles</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pickup_longitude</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitude coordinate of the pickup location</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pickup_latitude</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">latitude coordinate of the pickup location</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dropoff_longitude</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitude coordinate of the drop-off location</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dropoff_latitude</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">latitude coordinate of the drop-off location</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payment_type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the payment method - credit card or cash</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fare_amount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fare amount in dollars</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>surcharge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">surcharge in dollars</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mta_tax</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tax in dollars</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tip_amount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tip in dollars</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tolls_amount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bridge and tunnel tolls in dollars</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>total_amount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">total paid amount in dollars</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">source: DEBS 2015 Grand Challenge</div>
<p><br>
There are several different interesting avenues that could be explored within this dataset, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We could follow specific taxis to calculate the takings from one taxi throughout the course of a day, or calculate the distance from their last drop off to the next pickup to find out whether they are travelling far without a passenger</p>
</li>
<li>
<p>By using the distance and time of the taxi trip we could calculate the average speed, and use the coordinates of the pickup and drop off to try to guess the amount of traffic encountered</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The processing we have chosen for this example is relatively straightforward - we calculate the total amount of money (<code>fare_amount + tip_amount</code>) earned within a particular area of the city, based off of journeys starting there.
This involves splitting the input data into a grid of different cells, and summing the total amount of money taken for every journey that originates from any cell.
To do this we have to consider splitting up processing in a way that ensures correctness of our output.</p>
</div>
<div class="paragraph">
<p>We will build this example up step-by-step, starting with KafkaConnect and a custom built connector.</p>
</div>
</div>
<div class="sect2">
<h3 id="_getting_data_into_the_system">Getting Data into the System</h3>
<div class="paragraph">
<p>First things first, we need to make our dataset accessible from the cluster.
This would normally involve connecting to some service where we can poll the live data in real-time, but the data we have chosen is historical, and so we have to simulate the real-time behaviour.</p>
</div>
<div class="paragraph">
<p>The example connector we have built relies on hosting the file on an FTP server.
We picked this method as it allows our connector to easily communicate with a file external to the cluster.
For convenience, we use a python library <code>pyftpdlib</code> to host the file with the username and password set to <code>strimzi</code>.
For instructions on running the FTP server see <a href="https://github.com/adam-cattermole/strimzi-lab/tree/add-taxi-example/taxi-example#running-the-python-ftp-server">Running the Python FTP server</a>.</p>
</div>
<div class="paragraph">
<p>A Kafka Connector consists of both itself, and tasks (or workers) that perform the retrieval of the data through the <code>poll()</code> function.
The connector passes configuration over to the workers, and several workers can be invoked as per the <code>tasks.max</code> parameter.
We have created an <a href="../taxi-connect/src/main/java/io/strimzi/util/FTPConnection.java">FTPConnection</a> class, which provides the functions we require from the Apache Commons <a href="https://commons.apache.org/proper/commons-net/apidocs/org/apache/commons/net/ftp/FTPClient.html">FTPClient</a>.
On each call to <code>poll()</code> we retrieve the next line from the file, and publish this record to the topic provided in the configuration.</p>
</div>
<div class="paragraph">
<p>We need to add our connector plugin to the existing <a href="https://hub.docker.com/r/strimzi/kafka-connect">strimzi/kafka-connect</a> docker image, which is done by adding the JAR to the plugins folder, as described in the <a href="https://strimzi.io/docs/master/#creating-new-image-from-base-str">Strimzi documentation</a>.
We can then deploy the Kafka Connect cluster, using the configuration from the <a href="https://github.com/strimzi/strimzi-kafka-operator/blob/master/examples/kafka-connect/kafka-connect.yaml">existing KafkaConnect example</a>, but adding the <code>spec.image</code> field to point to the image containing our plugin.</p>
</div>
<div class="paragraph">
<p>KafkaConnect is exposed as a RESTful resource, and so to check which connector plugins are present we can run the following <code>GET</code> request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">kubectl exec -i my-cluster-kafka-0 -n kafka -- curl -s -X GET \
    http://my-connect-cluster-connect-api:8083/connector-plugins</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, to create a new connector we can <code>POST</code> the <code>JSON</code> configuration, as shown in the example below.
This new connector instance will establish an FTP connection to the server, and stream the data to the <code>taxi-source-topic</code>.
For this to work correctly, the following configuration options must be set correctly.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>connect.ftp.address</code> - FTP connection URL host:port.</p>
</li>
<li>
<p><code>connect.ftp.filepath</code> - Path to file on remote FTP server (from root).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Optional configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>connect.ftp.attempts</code> - Maximum number of attempts to retrieve a valid FTP connection. (default: 3)</p>
</li>
<li>
<p><code>connect.ftp.backoff.ms</code> - Backoff time in milliseconds between connection attempts. (default: 10000ms)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">kubectl exec -i my-cluster-kafka-0 -n kafka -- curl -s -X POST \
    -H "Accept:application/json" \
    -H "Content-Type:application/json" \
    http://my-connect-cluster-connect-api:8083/connectors -d @- &lt;&lt;'EOF'

{
    "name": "taxi-connector",
    "config": {
        "connector.class": "io.strimzi.TaxiSourceConnector",
        "connect.ftp.address": "&lt;ip-address&gt;",
        "connect.ftp.user": "strimzi",
        "connect.ftp.password": "strimzi",
        "connect.ftp.filepath": "sorteddata.csv",
        "connect.ftp.topic": "taxi-source-topic",
        "tasks.max": "1",
        "value.converter": "org.apache.kafka.connect.storage.StringConverter"
    }
}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can <code>GET</code> the current deployed connectors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">kubectl exec -i my-cluster-kafka-0 -n kafka -- curl -s -X GET \
    http://my-connect-cluster-connect-api:8083/connectors</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lets check that the data is streaming to the topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">kubectl run kafka-consumer -ti --image=strimzi/kafka:0.11.1-kafka-2.1.0 --rm=true --restart=Never -n kafka -- bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9092 --topic taxi-source-topic --from-beginning</code></pre>
</div>
</div>
<div class="paragraph">
<p>For debugging information, see the logs of <code>my-connect-cluster-connect</code>.</p>
</div>
<div class="paragraph">
<p>While we work on the rest of the application we can stop the plugin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">kubectl exec -i my-cluster-kafka-0 -n kafka -- curl -s -X DELETE \
    http://my-connect-cluster-connect-api:8083/connectors/taxi-connector</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kafka_streams_operations_on_the_data">Kafka Streams Operations on the Data</h3>
<div class="paragraph">
<p>Now that we have a topic with the <code>String</code> data we can start creating our application logic.
First up lets set up the configuration options for the Kafka streams application.
We do this in a separate config class, see <a href="../trip-convert-app/src/main/java/io/strimzi/TripConvertConfig.java">TripConvertConfig</a>, which still uses the same method of reading from environment variables, as described in the initial example.
It should be noted that this same method of providing configuration is used for each new application we build.</p>
</div>
<div class="paragraph">
<p>We can now generate the configuration options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">TripConvertConfig config = TripConvertConfig.fromMap(System.getenv());
Properties props = TripConvertConfig.createProperties(config);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As described in the basic example, the actions we perform will be to read from one topic, perform some kind of operation on the data, and write out to another topic.</p>
</div>
<div class="paragraph">
<p>Lets create the source stream in the same method as we have seen before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">StreamsBuilder builder = new StreamsBuilder();
KStream&lt;String, String&gt; source = builder.stream(config.getSourceTopic());</code></pre>
</div>
</div>
<div class="paragraph">
<p>The data we receive is currently in a format that is not easy to use.
Our long CSV data is represented as a <code>String</code>, and we do not have access to the individual fields.
To perform operations on the data, we need to convert the <code>&lt;String, String&gt;</code> (<code>&lt;key, value&gt;</code>) events into the type that we know of.
For this, we have created a POJO representing the <code>Trip</code> data type, and an <code>enum TripFields</code> representing the columns of each data element.
The function <code>constructTripFromString</code> takes each of the lines of CSV data, and converts them into <code>Trip</code>s.
This is implemented in the <a href="../trip-convert-app/src/main/java/io/strimzi/TripConvertApp.java">TripConvertApp</a> class.</p>
</div>
<div class="paragraph">
<p>The Kafka Streams DSL makes it easy to perform this function for every new record we receive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">KStream&lt;String, Trip&gt; mapped = source
                .map((key, value) -&gt; {
                    new KeyValue&lt;&gt;(key, constructTripFromString(value))
                });</code></pre>
</div>
</div>
<div class="paragraph">
<p>We could now write the <code>mapped</code> stream out to the sink topic, however the serialisation/deserialisation (SerDes) process for our value field has changed from the <code>Serdes.String()</code> that we set it to from the <a href="../trip-convert-app/src/main/java/io/strimzi/TripConvertConfig.java">TripConvertConfig</a> class.
As our <code>Trip</code> type is custom-built for our application, we must create our own SerDes implementation.
This is where the <a href="../trip-convert-app/src/main/java/io/strimzi/json/JsonObjectSerde.java">JsonObjectSerde</a> class comes into play.
We are using the <a href="https://vertx.io/docs/apidocs/io/vertx/core/json/JsonObject.html">Vertx JsonObject</a> implementation, and including our class type in the constructor to save us doing the hard work, although a different implementation may be better suited to another application.
The original <code>Trip</code> type only needs adjusting with appropriate <code>@JsonCreator</code> and <code>@JsonProperty</code> annotations.</p>
</div>
<div class="paragraph">
<p>We are now ready to output to our the <code>sinkTopic</code>, using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">final JsonObjectSerde&lt;Trip&gt; tripSerde = new JsonObjectSerde&lt;&gt;(Trip.class);
mapped.to(config.getSinkTopic(), Produced.with(Serdes.String(), tripSerde));</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_application_specific_information">Application Specific Information</h4>
<div class="paragraph">
<p>The intention for our application is to calculate the total monies received by all journeys originating from any particular cell.
We therefore must perform some calculations using the journey origin latitude and longitude, to determine the cell it belongs to.
We use the logic laid out in the DEBS Grand Challenge for defining the specifics of the grid.
See the figure below for an example.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="assets/taxi-grid.png" alt="Taxi Grid Example">
</div>
</div>
<div class="paragraph">
<p>We must set the origin of the grid (blue point), which represents the centre of grid cell (1,1), and a size in metres for every cell in the grid.
The cell size is converted into a latitude and longitude distance, <code>dy</code> and <code>dx</code> respectively, and the position of the top left of the grid is calculated (red point).
For any new arrival point we can easily count how many <code>dy</code> and <code>dx</code> away the coordinates are, and therefore in the example above (yellow point), we can determine that the journey originates from cell (3,4).</p>
</div>
<div class="paragraph">
<p>The additional application logic in the <a href="../trip-convert-app/src/main/java/io/strimzi/trip/Cell.java">Cell</a> class and <a href="../trip-convert-app/src/main/java/io/strimzi/TripConvertApp.java">TripConvertApp</a> perform this calculation, and we set the key of the new records as the <code>Cell</code> type.
To write to the <code>sinkTopic</code> we need a new SerDes, created in an identical fashion to the one we made before.</p>
</div>
<div class="paragraph">
<p>As we are using the default partitioning strategy, records are partitioned based on the different values of the keys, and so this change ensures that every <code>Trip</code> corresponding to a particular pickup <code>Cell</code> are distributed to the same partition.
When we perform processing downstream, the same processing node will receive all records corresponding to the same pickup cell, ensuring correctness and reproducibility of the operations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_aggregation">Aggregation</h3>
<div class="paragraph">
<p>We now have converted all of the incoming data to a type of <code>&lt;Cell, Trip&gt;</code>, and we would like to perform an aggregation operation.
Our intention is to calculate the sum of the <code>fare_amount + tip_amount</code> for every journey originating from one pickup cell, across a set time period.</p>
</div>
<div class="paragraph">
<p>As our data is historical, the time window that we use should be in relation to the original time that the events occurred, rather than the time that the event entered the Kafka system.
To do this, we need to provide a method of extracting this information from each record - a class that implements <code>TimestampExtractor</code>.
The <code>Trip</code> fields already contain this information for pickup and drop off times, and so the implementation is straightforward - see the implementation in <a href="../trip-metrics-app/src/main/java/io/strimzi/trip/TripTimestampExtractor.java">TripTimestampExtractor</a> for details.</p>
</div>
<div class="paragraph">
<p>Even though the topic we read from is already partitioned by cell, there are many more cells than partitions, and so each of our replicas will process the data for more than one cell.
To ensure that the windowing and aggregation is performed on a cell-by-cell basis, the <code>groupByKey()</code> function is called first, followed by a subsequent windowing operation.
As can be seen below, the window size is easily changeable, although for the time being we have opted for a window of 15 minutes.
The data can now be aggregated to generate the output metric we would like.
This is as simple as providing an accumulator value and the operation to perform for each record.
The output is of type <code>KTable</code>, where each key represents one particular window, and the value is the output of our aggregation opereation.
We use the <code>toStream()</code> function to convert it back to a kafka stream so that it can be output to the sink profit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">KStream&lt;Cell, Trip&gt; source = builder.stream(config.getSourceTopic(), Consumed.with(cellSerde, tripSerde));
KStream&lt;Windowed&lt;Cell&gt;, Double&gt; windowed = source
        .groupByKey(Serialized.with(cellSerde, tripSerde))
        .windowedBy(TimeWindows.of(TimeUnit.MINUTES.toMillis(15)))
        .aggregate(
                () -&gt; (double) 0,
                (key, value, profit) -&gt; {
                    profit + value.getFareAmount() + value.getTipAmount()
                },
                Materialized.&lt;Cell, Double, WindowStore&lt;Bytes, byte[]&gt;&gt;as("profit-store")
                        .withValueSerde(Serdes.Double()))
        .toStream();</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we do not require the information of which window the values belong to, we re-set the cell as the records keys, and round the value to two decimal places.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">KStream&lt;Cell, Double&gt; rounded = windowed
                .map((window, profit) -&gt; new KeyValue&lt;&gt;(window.key(), (double) Math.round(profit*100)/100));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the data can now be written to the output topic using the same method as defined before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">rounded.to(config.getSinkTopic(), Produced.with(cellSerde, Serdes.Double()));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_consume_and_visualise">Consume and Visualise</h3>
<div class="paragraph">
<p>We now have the windowed cell-based metric being output to the last topic, so the final step is to consume and visualise the data.
For this, we use the Vertx Kafka Consumer to read the data from our topic, and stream it to a JavaScript dashboard using the Vertx EventBus and sockjs (WebSockets). See <a href="../trip-consumer-app/src/main/java/io/strimzi/TripConsumerApp.java">TripConsumerApp</a> for the implementation.</p>
</div>
<div class="paragraph">
<p>This consumer application registers a handler that converts arriving records into a readable JSON format, and publishes it over an outbound EventBus channel.
The JavaScript connects to this channel and registers a handler for all incoming messages that performs relevant actions to visualise the data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">KafkaConsumer&lt;String, Double&gt; consumer = KafkaConsumer.create(vertx, props, String.class, Double.class);
        consumer.handler(record -&gt; {
            JsonObject json = new JsonObject();
            json.put("key", record.key());
            json.put("value", record.value());
            vertx.eventBus().publish("dashboard", json);
        });</code></pre>
</div>
</div>
<div class="paragraph">
<p>We log the information in a window so that the raw metric information can be seen, and use a geographical mapping library (<a href="https://leafletjs.com/">Leaflet</a>) to draw the original cells, modifying the opacity based on the value of the metric.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="assets/dashboard.png" alt="Screenshot of Dashboard">
</div>
</div>
<div class="paragraph">
<p>By modifying the starting latitude and longitude, or the cell size (in both <a href="../trip-consumer-app/src/main/resources/webroot/index.html">index.html</a> and <a href="../trip-convert-app/src/main/java/io/strimzi/TripConvertApp.java">TripConvertApp</a>) you can change the grid that is being worked with.
You can also adjust the logic in the aggregate function to calculate some alternative metric from the data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_system_architecture">System Architecture</h3>
<div class="paragraph">
<p>The application that we have built is detailed in the architecture diagram below.
Each of the topics are labelled with the keys and values that they contain.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="assets/taxi-implementation.png" alt="System Architecture">
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-04-26 13:18:44 +0100
</div>
</div>
</body>
</html>